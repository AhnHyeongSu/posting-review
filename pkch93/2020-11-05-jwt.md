# JWT

JWT 공식 홈페이지: [https://jwt.io/introduction/](https://jwt.io/introduction/)
JWT Toast 기술블로그: [https://meetup.toast.com/posts/239](https://meetup.toast.com/posts/239)
JWT best practice: [https://curity.io/resources/architect/api-security/jwt-best-practices/](https://curity.io/resources/architect/api-security/jwt-best-practices/)

## JWT란?

JWT는 일반적으로 클라이언트와 서버, 서비스와 서비스 사이에 통신 시 권한 인가를 위해 사용하는 토큰이다.

[RFC 7519](https://tools.ietf.org/html/rfc7519)에 JWT에 대한 명세가 있으며 [RFC 7523](https://tools.ietf.org/html/rfc7523)에 OAuth2 Client Authentication과 Authorization Grants에서 사용하는 명세가 있다.

JWT는 **HMAC** 알고리즘을 사용한 secret으로 서명을 하거나 **RSA**나 **ECDSA** 방식을 활용한 공개키/비밀키 방식으로 서명이 가능하다.

### JWT의 구조

```
HEADER.PAYLOAD.SIGNATURE
```

위와 같이 JWT는 `HEADER`, `PAYLOAD`, `SIGNATURE` 3가지 정보를 가지고 있으며 각각의 정보를 점 `.`으로 구분하고 있다. JWT는 기본적으로 base64 URL-Safe로 인코딩된다.

#### Header

Header는 JWT를 어떻게 검증하느냐에 대한 내용을 담고있다. `alg`와 `kid`로 구성한다.
`alg`는 서명 시 사용하는 알고리즘이며 `kid`는 서명 시 사용하는 키를 식별하는 값이다.

```
{
    "alg": "ES256",
    "kid": "Key ID"
}
```

#### Payload

JWT의 내용으로 Payload에 담긴 속성들을 `Claim Set`이라고 한다. `Claim Set`은 JWT의 토큰 생성자 정보, 생성 일시 같은 내용이나 클라이언트/서버 간 주고 받기로 한 값으로 구성한다.

Claim은 `registered`, `public`, `private`으로 3가지 Claim을 가진다.

- Registered Claims

  [JWT 명세](https://tools.ietf.org/html/rfc7519#section-4.1)에 이미 정의된 Claim이다.

  1. `iss`

     `issuer`의 뜻으로 JWT 발급자를 의미한다.

  2. `sub`

     `Subject`의 의미로 목적으로 해석하는 것이 맞지 않을까 생각한다.

  3. `aud`

     `Audience`의 의미로 JWT의 수신자를 의미.

  4. `exp`

     `Expiration Time`의 의미로 해당 JWT의 만료시간을 의미.

  5. `nbf`

     `Not Before`의 의미로 `exp`가 해당 시간 이후의 JWT는 사용될 수 없음을 의미하는 반면 `nbf`는 설정한 시간 이전에는 사용할 수 없음을 의미한다.

  6. `iat`

     `issued at`의 의미로 JWT의 발행 시간을 의미한다.

  7. `jti`

     `JWT ID`의 의미이다.

  위 Claim들은 모두 Optional이다.

- Public Claim

  사용자 마음대로 쓸 수 있으나 충돌 방지를 위해 [IANA Json Web Token Registry](http://iana.org/assignments/jwt/jwt.xhtml)에 정의된 Claim들을 사용하는 것을 권장한다.

- Private Claim

  제공하는 측 `아마 인증 서버`과 사용하는 측 `아마 클라이언트`에서 서로 주고받아 사용할 수 있도록 정의된 Claim.

```
{
    "iss": "jinho.shin",
		"memberId": "1"
}
```

#### Signature

Signature는 헤더와 페이로드를 합친 문자열을 서명한 값이다. 이 서명은 헤더에 정의한 `alg`의 알고리즘과 비밀키를 통해 생성한다.

```
HMACSHA256(
  base64UrlEncode(header) + "." +
  base64UrlEncode(payload),
  secret)
```

## JWT 활용

인증을 거치고 나면 JWT를 발급받는다. 이 경우 JWT는 곧 인증정보가 되므로 보안에 각별한 주의를 기울여야한다.

때문에 필요 이상으로 토큰을 오래 유지하는 것은 보안상 위험하며 또한 브라우저 Storage에 토큰을 보관하는 것은 보안 위협이 될 수 있다. 참고: [https://cheatsheetseries.owasp.org/cheatsheets/HTML5_Security_Cheat_Sheet.html#local-storage](https://cheatsheetseries.owasp.org/cheatsheets/HTML5_Security_Cheat_Sheet.html#local-storage)

클라이언트에서 애플리케이션에 보호하고 있는 리소스를 접근할 때는 일반적으로 JWT를 `Authorization` 헤더에 `Bearer` 스키마를 사용해서 전달한다.

```
Authorization: Bearer <token>
```
